GEMINI FUNCTION CALL FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                         USER ACTION                               â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ Types: "Change to a Jeep Wrangler"
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                    FRONTEND: ChatInterface.jsx                     â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  handleSendMessage()                                              â”ƒ
â”ƒ    â””â”€ sendMessageStreaming(message)                               â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ HTTP POST /run_sse
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                      BACKEND: FastAPI                             â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  Gemini API.generateContent({                                     â”ƒ
â”ƒ    contents: [{ text: "Change to a Jeep Wrangler" }],            â”ƒ
â”ƒ    tools: [function_declarations]                                 â”ƒ
â”ƒ  })                                                               â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ Returns response with function calls
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                     BACKEND: SSE Stream                           â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  data: {                                                          â”ƒ
â”ƒ    content: {                                                     â”ƒ
â”ƒ      parts: [                                                     â”ƒ
â”ƒ        { text: "Great! I'll switch to a Jeep..." },              â”ƒ
â”ƒ        {                                                          â”ƒ
â”ƒ          functionCall: {                                          â”ƒ
â”ƒ            name: "change_vehicle_model",                          â”ƒ
â”ƒ            args: { model_id: "jeep_jku" },                       â”ƒ
â”ƒ            id: "call-123"                                         â”ƒ
â”ƒ          }                                                         â”ƒ
â”ƒ        }                                                           â”ƒ
â”ƒ      ]                                                             â”ƒ
â”ƒ    }                                                               â”ƒ
â”ƒ  }                                                                 â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ SSE stream chunks
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ              FRONTEND: chat-api.js (sendMessageStreaming)         â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  1. Read SSE chunk                                                â”ƒ
â”ƒ     const parsedData = JSON.parse(eventData)                      â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  2. Extract text                                                  â”ƒ
â”ƒ     const text = extractTextFromEvent(parsedData)                 â”ƒ
â”ƒ     // "Great! I'll switch to a Jeep..."                          â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  3. Parse function calls â­ NEW                                    â”ƒ
â”ƒ     const commands = parseFunctionCallsFromEvent(parsedData)      â”ƒ
â”ƒ     allFunctionCallCommands.push(...commands)                     â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  4. Create structured response â­ NEW                              â”ƒ
â”ƒ     if (allFunctionCallCommands.length > 0) {                     â”ƒ
â”ƒ       structuredResponse = createStructuredResponse(commands)     â”ƒ
â”ƒ     }                                                              â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ Function call detected!
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ         FRONTEND: function-call-mapper.js â­ NEW                   â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  parseFunctionCallsFromEvent()                                    â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  parseFunctionCall({                                              â”ƒ
â”ƒ    name: "change_vehicle_model",                                  â”ƒ
â”ƒ    args: { model_id: "jeep_jku" },                               â”ƒ
â”ƒ    id: "call-123"                                                 â”ƒ
â”ƒ  })                                                                â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  1. mapFunctionNameToCommandType()                                â”ƒ
â”ƒ     "change_vehicle_model" â†’ "change_model"                       â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  2. transformParameters()                                         â”ƒ
â”ƒ     { model_id: "jeep_jku" } â†’ { model_id: "jeep_jku" }         â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  3. generateDescription()                                         â”ƒ
â”ƒ     "Changed vehicle to jeep_jku"                                 â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  Returns:                                                          â”ƒ
â”ƒ  {                                                                 â”ƒ
â”ƒ    command_type: "change_model",                                  â”ƒ
â”ƒ    parameters: { model_id: "jeep_jku" },                         â”ƒ
â”ƒ    description: "Changed vehicle to jeep_jku",                    â”ƒ
â”ƒ    client_id: "default",                                          â”ƒ
â”ƒ    function_call_id: "call-123"                                   â”ƒ
â”ƒ  }                                                                 â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ Command created!
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ              FRONTEND: chat-api.js (continued)                    â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  createStructuredResponse([command])                              â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  Returns finalMessage:                                            â”ƒ
â”ƒ  {                                                                 â”ƒ
â”ƒ    parts: [{ text: "Great! I'll switch..." }],                   â”ƒ
â”ƒ    structured: {                                                  â”ƒ
â”ƒ      vehicle_updates: [                                           â”ƒ
â”ƒ        {                                                           â”ƒ
â”ƒ          command_type: "change_model",                            â”ƒ
â”ƒ          parameters: { model_id: "jeep_jku" },                   â”ƒ
â”ƒ          description: "Changed vehicle to jeep_jku"              â”ƒ
â”ƒ        }                                                           â”ƒ
â”ƒ      ]                                                             â”ƒ
â”ƒ    }                                                               â”ƒ
â”ƒ  }                                                                 â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ Returns to ChatInterface
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                FRONTEND: ChatInterface.jsx                        â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  Receives finalMessage                                            â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  1. Display AI text in chat                                       â”ƒ
â”ƒ     "Great! I'll switch to a Jeep..."                            â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  2. Process structured response                                   â”ƒ
â”ƒ     if (finalMessage.structured) {                                â”ƒ
â”ƒ       await processAgentResponse(finalMessage.structured)         â”ƒ
â”ƒ     }                                                              â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ Call processAgentResponse
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ         FRONTEND: vehicle-update-handler.js (existing)            â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  processAgentResponse(structured)                                 â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  applyVehicleUpdates(vehicle_updates)                             â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  applyVehicleUpdate({                                             â”ƒ
â”ƒ    command_type: "change_model",                                  â”ƒ
â”ƒ    parameters: { model_id: "jeep_jku" },                         â”ƒ
â”ƒ    description: "Changed vehicle to jeep_jku"                     â”ƒ
â”ƒ  })                                                                â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  switch (command_type) {                                          â”ƒ
â”ƒ    case 'change_model':                                           â”ƒ
â”ƒ      handleChangeModel(parameters)                                â”ƒ
â”ƒ  }                                                                 â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ Call handler
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ         FRONTEND: vehicle-update-handler.js (existing)            â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  handleChangeModel({ model_id: "jeep_jku" })                     â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  1. Validate model exists                                         â”ƒ
â”ƒ     vehicleConfigs.vehicles["jeep_jku"] âœ“                        â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  2. Update game store                                             â”ƒ
â”ƒ     useGameStore.getState().setVehicle({ body: "jeep_jku" })    â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  3. Show notification                                             â”ƒ
â”ƒ     showNotification({                                            â”ƒ
â”ƒ       message: "Changed vehicle to jeep_jku",                     â”ƒ
â”ƒ       type: "success"                                             â”ƒ
â”ƒ     })                                                             â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ State updated!
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                  FRONTEND: gameStore.js (existing)                â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  setVehicle({ body: "jeep_jku" })                                â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  Updates currentVehicle state                                     â”ƒ
â”ƒ    â†“                                                               â”ƒ
â”ƒ  React components re-render                                       â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ State change detected
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                FRONTEND: Vehicle.jsx (existing)                   â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  useEffect(() => {                                                â”ƒ
â”ƒ    // Detects currentVehicle.body changed                         â”ƒ
â”ƒ    loadVehicleModel("jeep_jku")                                   â”ƒ
â”ƒ  }, [currentVehicle.body])                                        â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ Load new model
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                  FRONTEND: 3D Scene (Three.js)                    â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  1. Unload old Toyota 4Runner model                               â”ƒ
â”ƒ  2. Load Jeep Wrangler JKU model (.glb)                          â”ƒ
â”ƒ  3. Apply current wheel configuration                             â”ƒ
â”ƒ  4. Apply current lift                                            â”ƒ
â”ƒ  5. Apply current color                                           â”ƒ
â”ƒ  6. Render updated scene                                          â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                 â”‚
                                 â”‚ Scene rendered!
                                 â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                          USER SEES                                â”ƒ
â”ƒ                                                                    â”ƒ
â”ƒ  âœ… Chat message: "Great! I'll switch to a Jeep..."              â”ƒ
â”ƒ  âœ… Notification: "Changed vehicle to jeep_jku"                   â”ƒ
â”ƒ  âœ… 3D Scene: Jeep Wrangler JKU model displayed                   â”ƒ
â”ƒ  âœ… Update badge: "âœ“ Applied 1 change"                            â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

KEY COMPONENTS:

â­ NEW - function-call-mapper.js
  - Maps Gemini function names to internal commands
  - Transforms parameters
  - Generates descriptions

â­ MODIFIED - chat-api.js
  - Parses function calls from SSE stream
  - Creates structured responses

âœ“ EXISTING - vehicle-update-handler.js
  - Applies vehicle updates
  - Calls scene handlers
  - Shows notifications

âœ“ EXISTING - scene-handlers.js
  - Updates game store
  - Validates parameters

âœ“ EXISTING - gameStore.js
  - Manages vehicle state
  - Triggers React re-renders

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TIMELINE: ~200ms total

  0ms:   User types message
  50ms:  Backend receives request
  200ms: Gemini generates response with function call
  250ms: SSE stream starts
  260ms: Frontend parses function call â­ NEW
  261ms: Function mapped to command â­ NEW
  262ms: Structured response created â­ NEW
  265ms: Command applied to store
  270ms: 3D model starts loading
  500ms: New model fully loaded and rendered

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOGS TO WATCH:

Console output during function call:

  ğŸ“¨ [API] Parsed SSE data: {...}
  ğŸ“ [API] Function calls parsed: [...]
  ğŸ” [Function Call Mapper] Parsing function call
  âœ… [Function Call Mapper] Mapped to command type: change_model
  ğŸ“Š [API] Created structured response: {...}
  ğŸ¤– [Vehicle Update] PROCESSING AGENT RESPONSE
  ğŸ”§ [Vehicle Update] Applying: change_model
  ğŸš— [Handler] handleChangeModel called with: { model_id: 'jeep_jku' }
  âœ… [Handler] Model changed successfully
  âœ… [API] Streaming complete!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MULTIPLE FUNCTION CALLS:

When AI makes multiple changes at once:

  User: "Make it a red Jeep with a 3 inch lift"

  Gemini returns 3 function calls:
    1. change_vehicle_model â†’ Jeep
    2. change_vehicle_color â†’ Red
    3. adjust_lift â†’ 3 inches

  Flow:
    â†“ All parsed together
    â†“ All mapped to commands
    â†“ Structured response with 3 updates
    â†“ Applied sequentially (100ms delay each for visual feedback)
    â†“ User sees 3 notifications + final result

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

